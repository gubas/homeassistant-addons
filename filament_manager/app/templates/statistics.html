{% extends "base.html" %}

{% block content %}

<div class="page-header">
    <h2>üìä Statistiques</h2>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
            <div class="stat-label">Investissement total</div>
            <div class="stat-value">{{ "%.2f"|format(total_spent) }} {{ currency }}</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üñ®Ô∏è</div>
        <div class="stat-content">
            <div class="stat-label">Co√ªt des impressions</div>
            <div class="stat-value">{{ "%.2f"|format(total_consumption_cost) }} {{ currency }}</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-content">
            <div class="stat-label">Stock total restant</div>
            <div class="stat-value">{{ "%.0f"|format(total_remaining) }} g</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-content">
            <div class="stat-label">Stocks faibles</div>
            <div class="stat-value">{{ low_stock|length }}</div>
        </div>
    </div>
</div>

{% if consumption_by_type %}
<div class="section">
    <h3>üìà Consommation par type de filament</h3>
    <div class="chart-container">
        {% set total_consumption = consumption_by_type.values()|sum %}
        {% for fil_type, weight in consumption_by_type.items()|sort(attribute=1, reverse=True) %}
        <div class="chart-bar">
            <div class="chart-label">{{ fil_type }}</div>
            <div class="chart-progress">
                <div class="chart-fill"
                    style="width: {{ (weight / total_consumption * 100) if total_consumption > 0 else 0 }}%"></div>
            </div>
            <div class="chart-value">{{ "%.0f"|format(weight) }} g</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if low_stock %}
<div class="section">
    <h3>‚ö†Ô∏è Filaments en stock faible</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Couleur</th>
                    <th>Stock restant</th>
                    <th>%</th>
                </tr>
            </thead>
            <tbody>
                {% for fil in low_stock %}
                {% set percentage = ((fil['current_weight'] / fil['initial_weight']) * 100)|int if fil['initial_weight']
                > 0 else 0 %}
                <tr>
                    <td><strong>{{ fil['name'] }}</strong></td>
                    <td><span class="badge">{{ fil['type'] }}</span></td>
                    <td>{{ fil['color'] }}</td>
                    <td>{{ "%.0f"|format(fil['current_weight']) }} g</td>
                    <td><span class="percentage-badge low">{{ percentage }}%</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if consumptions %}
<div class="section">
    <h3>üïí Derni√®res consommations</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Impression</th>
                    <th>Filament</th>
                    <th>Quantit√©</th>
                    <th>Co√ªt</th>
                </tr>
            </thead>
            <tbody>
                {% for cons in consumptions[:20] %}
                <tr>
                    <td>{{ cons['consumption_date'][:10] }}</td>
                    <td>{{ cons['print_name'] or '-' }}</td>
                    <td>
                        <span class="badge">{{ cons['type'] }}</span>
                        {{ cons['filament_name'] }}
                    </td>
                    <td>{{ "%.1f"|format(cons['weight_used']) }} g</td>
                    <td>{{ "%.2f"|format(cons['cost']) }} {{ currency }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if not consumptions and not low_stock and not consumption_by_type %}
<div class="empty-state">
    <div class="empty-icon">üìä</div>
    <h3>Pas encore de donn√©es</h3>
    <p>Les statistiques appara√Ætront une fois que vous aurez enregistr√© des consommations.</p>
</div>
{% endif %}

{% endblock %}